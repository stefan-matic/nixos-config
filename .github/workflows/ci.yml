# GitHub Actions CI Pipeline for NixOS Flake Configuration
#
# Default behavior (every commit):
#   - Fast syntax checking and linting (no package downloads)
#   - Flake evaluation validation
#
# Full builds (when RUN_FULL_BUILDS=true):
#   - Actually build all NixOS and Home Manager configurations
#   - Downloads all packages and dependencies
#
# To trigger full builds:
#   - Manual dispatch with full_builds=true
#   - Or set repository variable RUN_FULL_BUILDS=true

name: NixOS CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      full_builds:
        description: "Run full builds (downloads packages)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

env:
  NIX_CONFIG: "experimental-features = nix-command flakes"
  NIXPKGS_ALLOW_UNFREE: "1"
  NIXPKGS_ALLOW_UNSUPPORTED_SYSTEM: "1"

jobs:
  ###################
  # Linting
  ###################

  nix-fmt-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Check formatting
        run: nix run nixpkgs#nixfmt-rfc-style -- --check .
        continue-on-error: true

  statix-lint:
    name: Statix Lint
    runs-on: ubuntu-latest
    if: github.event.inputs.full_builds == 'true' || vars.RUN_FULL_BUILDS == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Run statix
        run: nix run nixpkgs#statix -- check .
        continue-on-error: true

  deadnix-check:
    name: Deadnix Check
    runs-on: ubuntu-latest
    if: github.event.inputs.full_builds == 'true' || vars.RUN_FULL_BUILDS == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Run deadnix
        run: nix run nixpkgs#deadnix -- --fail .
        continue-on-error: true

  ###################
  # Validation
  ###################

  flake-check:
    name: Flake Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Run flake check
        run: nix flake check --all-systems --no-build --show-trace --impure

  flake-eval:
    name: Flake Eval
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Evaluate NixOS configurations
        run: nix eval .#nixosConfigurations --apply builtins.attrNames

  ###################
  # Build NixOS Configurations
  ###################

  build-zvijer:
    name: Build ZVIJER
    runs-on: ubuntu-latest
    needs: [flake-check, flake-eval]
    if: github.event.inputs.full_builds == 'true' || vars.RUN_FULL_BUILDS == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Build ZVIJER
        run: nix build .#nixosConfigurations.ZVIJER.config.system.build.toplevel --show-trace

  build-t14:
    name: Build T14
    runs-on: ubuntu-latest
    needs: [flake-check, flake-eval]
    if: github.event.inputs.full_builds == 'true' || vars.RUN_FULL_BUILDS == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Build T14
        run: nix build .#nixosConfigurations.stefan-t14.config.system.build.toplevel --show-trace

  build-starlabs:
    name: Build StarLabs
    runs-on: ubuntu-latest
    needs: [flake-check, flake-eval]
    if: github.event.inputs.full_builds == 'true' || vars.RUN_FULL_BUILDS == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Build StarLabs
        run: nix build .#nixosConfigurations.starlabs.config.system.build.toplevel --show-trace

  build-z420:
    name: Build Z420
    runs-on: ubuntu-latest
    needs: [flake-check, flake-eval]
    if: github.event.inputs.full_builds == 'true' || vars.RUN_FULL_BUILDS == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Build Z420
        run: nix build .#nixosConfigurations.z420.config.system.build.toplevel --show-trace

  build-dell-micro:
    name: Build Dell Micro
    runs-on: ubuntu-latest
    needs: [flake-check, flake-eval]
    if: github.event.inputs.full_builds == 'true' || vars.RUN_FULL_BUILDS == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Build Dell Micro 3050
        run: nix build .#nixosConfigurations.dell-micro-3050.config.system.build.toplevel --show-trace

  ###################
  # Summary
  ###################

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [nix-fmt-check, flake-check, flake-eval]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "=========================================="
          echo "NixOS Configuration Validation Complete!"
          echo "=========================================="
          if [ "${{ github.event.inputs.full_builds }}" = "true" ] || [ "${{ vars.RUN_FULL_BUILDS }}" = "true" ]; then
            echo "Mode: Full builds (all packages downloaded and built)"
          else
            echo "Mode: Fast validation (syntax and evaluation checks only)"
            echo ""
            echo "To run full builds:"
            echo "  - Use workflow_dispatch with full_builds=true"
            echo "  - Or set repository variable RUN_FULL_BUILDS=true"
          fi
