# GitLab CI Pipeline for NixOS Flake Configuration
#
# Default behavior (every commit):
#   - Fast syntax checking and linting (no package downloads)
#   - Flake evaluation validation
#
# Full builds (when RUN_FULL_BUILDS=true):
#   - Actually build all NixOS and Home Manager configurations
#   - Downloads all packages and dependencies
#
# To trigger full builds, set CI/CD variable: RUN_FULL_BUILDS=true

image: nixos/nix:latest

variables:
  # Enable flakes and nix-command for all jobs
  NIX_CONFIG: "experimental-features = nix-command flakes"
  # Speed up builds by using more cores
  NIX_BUILD_CORES: "4"
  # Allow unfree packages (needed for Steam and other proprietary software)
  NIXPKGS_ALLOW_UNFREE: "1"
  # Allow packages unsupported on some systems (for multi-arch validation)
  NIXPKGS_ALLOW_UNSUPPORTED_SYSTEM: "1"
  # Set RUN_FULL_BUILDS=true to enable actual package builds (off by default)
  RUN_FULL_BUILDS: "false"

# Cache the Nix store between pipeline runs
cache:
  key: nix-store-cache
  paths:
    - .nix-cache/

# Run before each job to set up Nix properly
before_script:
  - nix --version
  - nix flake metadata

stages:
  - lint
  - validate
  - build-system

###################
# Linting Stage
###################

nix-fmt-check:
  stage: lint
  script:
    - echo "Checking Nix code formatting with nixfmt (RFC style)..."
    - nix run nixpkgs#nixfmt-rfc-style -- --check .
  allow_failure: true # Don't block pipeline on formatting issues
  only:
    - merge_requests
    - main

statix-lint:
  stage: lint
  script:
    - echo "Running statix linter for Nix anti-patterns..."
    - nix run nixpkgs#statix -- check .
  allow_failure: true # Don't block pipeline on linting suggestions
  rules:
    - if: $RUN_FULL_BUILDS == "true"
      when: on_success
    - when: never

deadnix-check:
  stage: lint
  script:
    - echo "Checking for dead/unused Nix code..."
    - nix run nixpkgs#deadnix -- --fail .
  allow_failure: true # Don't block pipeline on dead code
  rules:
    - if: $RUN_FULL_BUILDS == "true"
      when: on_success
    - when: never

###################
# Validation Stage
###################

flake-check:
  stage: validate
  script:
    - echo "Running nix flake check..."
    # Use --no-build to only check evaluation, not actual builds
    # Actual builds are tested in the build-* stages
    - nix flake check --all-systems --no-build --show-trace --impure
  only:
    - merge_requests
    - main

flake-eval:
  stage: validate
  script:
    - echo "Evaluating flake outputs..."
    - nix eval .#nixosConfigurations --apply builtins.attrNames
  only:
    - merge_requests
    - main

###################
# Build NixOS System Configurations
###################

build-zvijer:
  stage: build-system
  script:
    - echo "Building NixOS configuration for ZVIJER..."
    - nix build .#nixosConfigurations.ZVIJER.config.system.build.toplevel --show-trace
  rules:
    - if: $RUN_FULL_BUILDS == "true"
      when: on_success
    - when: never

build-t14:
  stage: build-system
  script:
    - echo "Building NixOS configuration for stefan-t14..."
    - nix build .#nixosConfigurations.stefan-t14.config.system.build.toplevel --show-trace
  rules:
    - if: $RUN_FULL_BUILDS == "true"
      when: on_success
    - when: never

build-starlabs:
  stage: build-system
  script:
    - echo "Building NixOS configuration for starlabs..."
    - nix build .#nixosConfigurations.starlabs.config.system.build.toplevel --show-trace
  rules:
    - if: $RUN_FULL_BUILDS == "true"
      when: on_success
    - when: never

build-z420:
  stage: build-system
  script:
    - echo "Building NixOS configuration for z420..."
    - nix build .#nixosConfigurations.z420.config.system.build.toplevel --show-trace
  rules:
    - if: $RUN_FULL_BUILDS == "true"
      when: on_success
    - when: never

build-dell-micro-3050:
  stage: build-system
  script:
    - echo "Building NixOS configuration for dell-micro-3050..."
    - nix build .#nixosConfigurations.dell-micro-3050.config.system.build.toplevel --show-trace
  rules:
    - if: $RUN_FULL_BUILDS == "true"
      when: on_success
    - when: never

# Liveboot builds commented out - configurations are incomplete
# Uncomment when liveboot configs are fixed
#build-liveboot:
#  stage: build-system
#  script:
#    - echo "Building NixOS configuration for liveboot..."
#    - nix build .#nixosConfigurations.liveboot.config.system.build.toplevel --show-trace
#  only:
#    - merge_requests
#    - main
#  allow_failure: true  # Optional configuration
#
#build-liveboot-iso:
#  stage: build-system
#  script:
#    - echo "Building NixOS ISO for liveboot-iso..."
#    - nix build .#nixosConfigurations.liveboot-iso.config.system.build.isoImage --show-trace
#  only:
#    - merge_requests
#    - main
#  allow_failure: true  # ISO builds can be slow/large

###################
# Summary Job
###################

validation-summary:
  stage: .post
  script:
    - echo "=========================================="
    - echo "NixOS Configuration Validation Complete!"
    - echo "=========================================="
    - if [ "$RUN_FULL_BUILDS" = "true" ]; then echo "✓ Full builds completed"; else echo "✓ Fast validation completed"; fi
    - echo ""
    - echo "Validated hosts:"
    - echo "  - ZVIJER, stefan-t14, starlabs, z420, dell-micro-3050"
    - echo ""
    - echo "Note: Home Manager is integrated into NixOS configs"
  only:
    - merge_requests
    - main
  when: on_success
